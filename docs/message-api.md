#API between drachtio client and server

Here are the rules of messages:

1. Messages consist of a header, and optionally a sip message that follows the header, separated by a newline.
2. The message header consists of tokens separated by a '|' character
3. The first token in a message header is the message id, which is an alphanumeric string guaranteed to be globally unique.
4. The second token in a message header is the message type, which is a string identifier. Current message types are as follows:
	* authenticate - sent by the client to authenticate itself with the serve
	* route - sent by the client to indicate an interest in receiving a specific type of SIP message
	* response - sent by either client or server to indicate success or failure to a previous request message
	* sip - sent by either side to represent a SIP message: may be a notification of an incoming SIP message from the network that needs to be handled (when sent by the server), may be a request to send a SIP message (when sent by the client), or may be a notification of an actual SIP message that was sent by the server (when sent by the server).
5. Further tokens in the message correspond to the specific type of message being sent


Here is an example of a client connecting, authenticating, and then requesting INVITEs and BYEs.

```js
(client establishes TCP socket connection to server)
1 C->S: 15ec4f40-466f-11e4-8b56-6bd477af830c|authenticate|cymru 

2 S->C: c558f1cb-db7b-4dd2-ba3f-3e529c2e3c42|response|15ec4f40-466f-11e4-8b56-6bd477af830c|OK|192.168.1.4

3 C->S: 15ed60b0-466f-11e4-8b56-6bd477af830c|route|invite

4 C->S: 15ed60b1-466f-11e4-8b56-6bd477af830c|route|bye

5 S->C: 64b9fbbd-5733-46e3-8092-47d6f896924b|response|15ed60b0-466f-11e4-8b56-6bd477af830c|OK

6 S->C: fd178df6-5d76-467d-aa64-68af4cc2d30c|response|15ed60b1-466f-11e4-8b56-6bd477af830c|OK
```

Here is more detail on the above messaging sequence:

* (line 1) The client sends an authenticate message with id '15ec4f40-466f-11e4-8b56-6bd477af830c' to the server, specifying a secret of 'cyrmu'.
* (line 2) The server responds with success, and additional piece of information which is the SIP contact address that it is listening on (192.168.1.4 in this case).
* (line 3-4) The client requests to receive incoming INVITE and BYE messages.
* (line 4-5) The server responds with success to both requests.

Let's continue the example and presume that the server receives an incoming INVITE message that it wants to send to the client.  In this case, the client responds with a 486 Busy Here.

```js
1 S->C: fa602e8c-83a9-43c3-9555-4980882b4b71|sip|network|1012|udp|127.0.0.1|23460|18:02:49.715381|ab27da5b-6559-4bce-9a2c-5d2af5532dda|
INVITE sip:11@localhost SIP/2.0 ..remainder of sip message...

2 C->S: 7e4e9c40-4670-11e4-8b56-6bd477af830c|sip|ab27da5b-6559-4bce-9a2c-5d2af5532dda
SIP/2.0 486 Busy Here ..remainder of sip message...

3 S->C:  b68f0330-205b-437f-a6d6-26e5a4e2929b|sip|application|286|udp|127.0.0.1|23460|18:02:49.721064|ab27da5b-6559-4bce-9a2c-5d2af5532dda|
SIP/2.0 100 Trying ...remainder of sip message...

4 S->C: 2ae609a6-70c9-4d1d-9a20-320478d72ef8|response|7e4e9c40-4670-11e4-8b56-6bd477af830c|OK

5 S->C: 85ecbd48-d5f3-4c62-8e0d-ecbb99c79b48|sip|application|348|udp|127.0.0.1|23460|18:02:49.734064|ab27da5b-6559-4bce-9a2c-5d2af5532dda|
SIP/2.0 486 Busy Here ...remainder of sip message...

6 S->C:  2eeb9718-ac1d-4954-9e7c-7fb2ff614f5a|sip|network|323|udp|127.0.0.1|23460|18:02:49.756286|998ea761-6cb8-4eb0-b04e-b9e8f27f6d49|YmM5NGVkNDg2ZTE2YmJkYzJhMDI4MTI1ZDg3M2U0YmU;uas|
ACK sip:11@localhost SIP/2.0
```
Again, here is more detail:

* (line 1) The server sends an incoming INVITE to the client.  The header line includes the following: message id, message type (sip), message originator (network or application, in this case network), size of the message in bytes, protocol, source address, source port, server time message was received, server transaction id assigned to this request.
* (line 2) The client responds with a 486 Busy Here response to the message.  The message header includes the server transaction id to reference the server to the specific transaction being handled.
* (line 3) The server sends a notification to the client of the 100 Trying message that was generated by the server automatically for this request.  
	> Although the client needs take no action with regards to this notification, by receiving notifications like this for all messages generated by the server the client is able to maintain a complete and accurate SIP trace for all calls that it handles, which can be critical in debugging problems.
* (line 4) The server responds with success to the client's request to send the 486 in response to the INVITE
* (line 5) The server sends a notification of the actual 486 response that was sent
* (line 6) The server sends a notification of the enusing ACK request that was received.